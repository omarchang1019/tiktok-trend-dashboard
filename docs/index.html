<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TikTok Trends Radar</title>
  <meta name="color-scheme" content="dark" />
  <!-- avoid favicon 404 -->
  <link rel="icon" href="data:," />

  <style>
    :root{
      --bg:#0b0f17;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --border: rgba(255,255,255,.12);
      --text:#e9eefc;
      --muted: rgba(233,238,252,.72);
      --muted2: rgba(233,238,252,.55);
      --ok:#43ffb4;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(81,118,255,.25), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(67,255,180,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,92,122,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 16px 34px;
    }
    .header{
      display:flex;
      align-items:center;
      gap:12px;
      margin: 6px 0 16px;
    }
    .logo{
      width:44px;height:44px;
      display:grid;place-items:center;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      font-size: 22px;
    }
    h1{
      margin:0;
      font-size: clamp(22px, 4vw, 34px);
      letter-spacing: .2px;
      line-height:1.1;
    }
    .sub{
      margin:4px 0 0;
      font-size: 13px;
      color: var(--muted2);
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.045));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .controls{
      display:grid;
      grid-template-columns: 160px 220px 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .label{
      font-size:12px;
      color:var(--muted2);
      letter-spacing:.2px;
    }
    select, input{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline: none;
    }
    input::placeholder{color: rgba(233,238,252,.35)}
    .row2{
      display:grid;
      grid-template-columns: 1fr 140px 140px 140px;
      gap:10px;
      margin-top: 10px;
      align-items:end;
    }
    .btn{
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.08);
      color: var(--text);
      cursor:pointer;
      font-weight: 600;
    }
    .btn:hover{background: rgba(255,255,255,.12)}
    .btn:active{transform: translateY(1px)}
    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--muted2)}
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .dot.warn{background: var(--warn)}

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      margin-top: 14px;
    }
    .card{
      border-radius: 18px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.24);
      padding: 14px;
      overflow:hidden;
      min-height: 134px;
      position:relative;
    }
    .card:hover{background: rgba(0,0,0,.29)}
    .topline{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom: 10px;
    }
    .title{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 15px;
      line-height:1.25;
      margin:0;
      word-break: break-word;
    }
    .rank{
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      padding: 6px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .tag{
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top: 10px;
      color: var(--text);
      text-decoration:none;
      font-weight: 700;
      font-size: 13px;
      opacity:.92;
    }
    .link:hover{opacity:1}
    .muted{color: var(--muted2)}
    .empty{
      padding: 22px 14px;
      border-radius: 18px;
      border:1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      margin-top: 14px;
    }
    .small{
      font-size: 12px;
      color: var(--muted2);
    }

    @media (max-width: 980px){
      .grid{grid-template-columns: repeat(2, minmax(0,1fr))}
      .controls{grid-template-columns: 1fr 1fr}
      .row2{grid-template-columns: 1fr 1fr}
      .row2 .field:last-child{grid-column: 1 / -1;}
    }
    @media (max-width: 560px){
      .grid{grid-template-columns: 1fr}
      .controls{grid-template-columns: 1fr}
      .row2{grid-template-columns: 1fr 1fr}
      .row2 .field:nth-child(1){grid-column: 1/-1;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">üìà</div>
      <div>
        <h1>TikTok Trends Radar</h1>
        <div class="sub">Real-time trending signals via TikTok Creative Center (unofficial). Mobile-friendly, English UI.</div>
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <div class="field">
          <div class="label">Country</div>
          <select id="country">
            <option value="US">US</option>
            <option value="JP">JP</option>
            <option value="KR">KR</option>
            <option value="GB">GB</option>
            <option value="DE">DE</option>
            <option value="FR">FR</option>
            <option value="TR">TR</option>
            <option value="ID">ID</option>
            <option value="VN">VN</option>
            <option value="TH">TH</option>
            <option value="PH">PH</option>
            <option value="BR">BR</option>
            <option value="MX">MX</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Type</div>
          <select id="type">
            <option value="hashtags">Trending Hashtags</option>
            <option value="songs">Trending Sounds</option>
            <option value="videos">Trending Videos</option>
            <option value="creators">Trending Creators</option>
          </select>
        </div>

        <div class="field">
          <div class="label">Search keyword</div>
          <input id="q" type="search" placeholder="Search by name / title / author..." />
        </div>
      </div>

      <div class="row2">
        <div class="field">
          <div class="label">API Base</div>
          <input id="apiBase" type="url" spellcheck="false" value="https://tiktok-creative-center-api-orcin.vercel.app" />
          <div class="small">Example: https://your-vercel-domain.vercel.app</div>
        </div>

        <div class="field">
          <div class="label">Period</div>
          <select id="period">
            <option value="1">Last 24 hours</option>
            <option value="7" selected>Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="120">Last 120 days</option>
          </select>
        </div>

        <div class="field">
          <button class="btn" id="btnLoad">Load</button>
        </div>
      </div>

      <div class="status">
        <div class="pill"><span class="dot" id="dot"></span><span id="statusText">Ready.</span></div>
        <div class="pill"><span class="muted">Tip:</span> <span class="muted">If you see no results, try another country or remove search keyword.</span></div>
      </div>
    </div>

    <div id="content"></div>
    
    <div class="panel" style="margin-top:14px;">
  <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
    <div class="pill" style="display:flex; align-items:center; gap:10px;">
      <span class="dot ok"></span>
      <span id="pageInfo">Page 1</span>
      <span id="pageTotal" style="opacity:.7;"></span>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn" id="btnPrev">Prev</button>
      <button class="btn" id="btnNext">Next</button>

      <div class="pill" style="display:flex; gap:8px; align-items:center;">
        <span style="opacity:.8;">Go</span>
        <input id="pageJump" type="number" min="1" placeholder="1"
               style="width:80px; background:transparent; border:none; outline:none; color:inherit;">
        <button class="btn" id="btnGo">Go</button>
      </div>
    </div>
  </div>
</div>

</div> <!-- wrap ends -->

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);

    function setStatus(kind, text){
      const dot = $("dot");
      dot.className = "dot" + (kind ? " " + kind : "");
      $("statusText").textContent = text;
    }

    function cleanBaseUrl(s){
      return (s || "").trim().replace(/\/+$/,"");
    }

    function normalizeItems(json){
  if (!json) return [];
  if (Array.isArray(json)) return json;

  const d = (json.data !== undefined) ? json.data : json;

  // 1) direct array
  if (Array.isArray(d)) return d;

  // 2) common key names (based on your real responses)
  if (d && Array.isArray(d.list)) return d.list;        // hashtags
  if (d && Array.isArray(d.videos)) return d.videos;    // videos
  if (d && Array.isArray(d.songs)) return d.songs;
  if (d && Array.isArray(d.sounds)) return d.sounds;
  if (d && Array.isArray(d.music)) return d.music;
  if (d && Array.isArray(d.musics)) return d.musics;
  if (d && Array.isArray(d.sound_list)) return d.sound_list;
  if (d && Array.isArray(d.music_list)) return d.music_list;
  if (d && Array.isArray(d.songs_list)) return d.songs_list;
  if (d && Array.isArray(d.rank_list)) return d.rank_list;
  if (d && Array.isArray(d.creators)) return d.creators;// likely

  // 3) other common shapes
  if (d && Array.isArray(d.items)) return d.items;
  if (d && Array.isArray(d.rank_list)) return d.rank_list;

  // 4) deeper fallback
  if (d && d.data && Array.isArray(d.data)) return d.data;
  if (d && d.data && Array.isArray(d.data.list)) return d.data.list;

  return [];
}

    function parseToSec(v){
  const n = Number(v);
  if (!Number.isFinite(n)) return null;
  // heuristic: ms timestamps are huge (>= 1e12)
  if (n >= 1e12) return Math.floor(n / 1000);
  // sec timestamps (>= 1e9) typical
  if (n >= 1e9) return Math.floor(n);
  // some APIs use smaller seconds but that would be too old; still accept
  return Math.floor(n);
}

function getItemTsSec(it){
  // try common fields (seconds or ms)
  const candidates = [
    "publish_time","publishTime",
    "create_time","createTime",
    "create_time_ms","createTimeMs",
    "item_create_time","itemCreateTime",
    "video_create_time","videoCreateTime",
    "upload_time","uploadTime",
    "on_list_time","on_list_times","onListTime",
  ];

  for (const k of candidates){
    const v = it?.[k];
    if (v === undefined || v === null || v === "") continue;
    const sec = parseToSec(v);
    if (sec) return sec;
  }

  return null;
}

    function toText(v){
      if (v === null || v === undefined) return "";
      return String(v);
    }

    function pick(obj, keys){
      for (const k of keys){
        const v = obj?.[k];
        if (v !== undefined && v !== null && v !== "") return v;
      }
      return undefined;
    }

    function formatNumber(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return "";
      return x.toLocaleString();
    }

    function containsQuery(item, q){
      if (!q) return true;
      const s = JSON.stringify(item).toLowerCase();
      return s.includes(q.toLowerCase());
    }

    // ---------- endpoints ----------
    function buildPath(type, country, period, page){
  // ‚úÖ SAFETY: API only supports 7/30/120
  const apiPeriod = (period === "1") ? "7" : period;

  // fixed page size
  const limit = PAGE_SIZE;

  if (type === "creators"){
    return `/api/creators?country=${encodeURIComponent(country)}&limit=${limit}&page=${encodeURIComponent(page)}`;
  }
  return `/api/${type}?country=${encodeURIComponent(country)}&period=${encodeURIComponent(apiPeriod)}&limit=${limit}&page=${encodeURIComponent(page)}`;
}

    // ---------- render ----------
    function renderCards(type, items, q){
      const root = $("content");
      root.innerHTML = "";

      const filtered = (items || []).filter(it => containsQuery(it, q));
      if (!filtered.length){
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "No results. Try another country/type/keyword.";
        root.appendChild(div);
        return;
      }

      const grid = document.createElement("div");
      grid.className = "grid";

      for (const it of filtered){
        const card = document.createElement("div");
        card.className = "card";

        // generic fields (best-effort across types)
        const rank = pick(it, ["rank", "rank_no", "ranking", "position"]);
        const title =
          type === "hashtags"
            ? ("#" + toText(pick(it, ["hashtag_name", "challenge_name", "name", "title", "tag"])).replace(/^#/,""))
            : type === "songs"
              ? toText(pick(it, ["song_title", "music_title", "title", "name"]))
              : type === "creators"
                ? toText(pick(it, ["nick_name", "nickname", "creator_name", "name", "unique_id"]))
                : toText(pick(it, ["title", "desc", "video_title", "name"])) || "Untitled";

        const author =
          type === "videos"
            ? toText(pick(it, ["author", "author_name", "nickname", "nick_name"]))
            : type === "songs"
              ? toText(pick(it, ["author", "artist", "singer"]))
              : "";

        let link = toText(pick(it, [
  "link",
  "url",
  "share_url",
  "music_url",
  "author_url",
  "creator_url",
  "profile_url",
  "tiktok_url",
  "item_url",
  "jump_url",
  "redirect_url"
])) || "";

// if API returns relative paths like "/music/..." or "/@user"
if (link && link.startsWith("/")) {
  link = "https://www.tiktok.com" + link;
}

        // numeric meta
        const views = pick(it, ["vv", "view_cnt", "views", "play_cnt", "video_view_cnt"]);
        const likes = pick(it, ["like_cnt", "likes"]);
        const followers = pick(it, ["follower_cnt", "followers"]);
        const posts = pick(it, ["video_cnt", "posts", "post_cnt"]);
        const region = pick(it, ["country_code", "country", "creator_country"]);

        // cover
        const cover = toText(pick(it, ["cover", "cover_uri", "cover_url", "avatar_url", "avatar", "thumb", "thumbnail"])) || "";

        // top line
        const top = document.createElement("div");
        top.className = "topline";

        const h = document.createElement("div");
        const t = document.createElement("p");
        t.className = "title";
        t.textContent = title || "(no title)";
        h.appendChild(t);

        if (author){
          const au = document.createElement("div");
          au.className = "small";
          au.textContent = author;
          h.appendChild(au);
        }

        top.appendChild(h);

        const r = document.createElement("div");
        r.className = "rank";
        r.textContent = (rank !== undefined) ? `Rank #${rank}` : "Rank";
        top.appendChild(r);

        card.appendChild(top);

        // tags/meta
        const meta = document.createElement("div");
        meta.className = "meta";

        if (region) meta.appendChild(tagEl(`Region: ${region}`));

        if (type === "creators"){
          if (followers !== undefined) meta.appendChild(tagEl(`Followers: ${formatNumber(followers)}`));
          if (posts !== undefined) meta.appendChild(tagEl(`Videos: ${formatNumber(posts)}`));
        } else {
          if (views !== undefined) meta.appendChild(tagEl(`Views: ${formatNumber(views)}`));
          if (likes !== undefined) meta.appendChild(tagEl(`Likes: ${formatNumber(likes)}`));
        }

        // extra: period hint
        if (type !== "creators"){
          meta.appendChild(tagEl(`Period: ${$("period").value}d`));
        }

        card.appendChild(meta);

        // cover preview (optional)
        if (cover && /^https?:\/\//i.test(cover)){
          const img = document.createElement("img");
          img.src = cover;
          img.alt = "";
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";
          img.style.width = "100%";
          img.style.height = "140px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "14px";
          img.style.marginTop = "10px";
          img.style.border = "1px solid rgba(255,255,255,.10)";
          card.appendChild(img);
        }

        if (link && /^https?:\/\//i.test(link)){
          const a = document.createElement("a");
          a.className = "link";
          a.href = link;
          a.target = "_blank";
          a.rel = "noreferrer noopener";
          a.textContent = "Open on TikTok ‚Üó";
          card.appendChild(a);
        } else {
          const m = document.createElement("div");
          m.className = "small muted";
          m.style.marginTop = "10px";
          m.textContent = "No direct link available.";
          card.appendChild(m);
        }

        grid.appendChild(card);
      }

      root.appendChild(grid);

      function tagEl(text){
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = text;
        return s;
      }
    }

    // ---------- load ----------
    async function load(){
  const base = cleanBaseUrl($("apiBase").value);
  const country = $("country").value;
  const type = $("type").value;
  const period = $("period").value;
  const q = $("q").value.trim();

  // save last query state for pagination buttons
  LAST_COUNTRY = country;
  LAST_TYPE = type;
  LAST_PERIOD = period;
  LAST_Q = q;

  if (!base.startsWith("http")){
    setStatus("bad", "Please set a valid API Base URL (Vercel URL).");
    return;
  }

  const path = buildPath(type, country, period, CURRENT_PAGE);
  const url = base + path;

  console.log("LOAD page =", CURRENT_PAGE);
  console.log("API URL:", url);

      setStatus("warn", "Loading‚Ä¶");
      try{
        const resp = await fetch(url, { method: "GET" });
        const json = await resp.json().catch(() => null);
        
        const pg = json?.data?.pagination || json?.pagination || null;
        
        LAST_HAS_MORE = !!(pg?.has_more ?? pg?.hasMore);
        
        // total count (optional)
        LAST_TOTAL_COUNT = pg?.total_count ?? pg?.total ?? pg?.count ?? null;
        
        if (LAST_TOTAL_COUNT != null) {
          const n = Number(LAST_TOTAL_COUNT);
          LAST_TOTAL_PAGES = Number.isFinite(n)
            ? Math.max(1, Math.ceil(n / PAGE_SIZE))
            : null;
        } else {
          LAST_TOTAL_PAGES = null;
        }


        // debug (open console if needed)
        console.log("API URL:", url);
        console.log("API raw response:", json);

        if (!resp.ok){
  setStatus("bad", `HTTP ${resp.status} ‚Äì ${toText(json?.error || json?.message || "Request failed")}`);
  renderCards(type, [], q);
  updatePager();
  return;
}

        const items = normalizeItems(json);
console.log("Normalized items length:", items.length);

const uiPeriod = $("period").value; // "1" | "7" | "30" | "120"

let finalItems = items;
let droppedNoTs = 0;
let droppedOld = 0;

if (uiPeriod === "1") {
  const nowSec = Math.floor(Date.now() / 1000);
  const cutoff = nowSec - 24 * 3600;

  finalItems = items.filter(it => {
    const ts = getItemTsSec(it);
    if (!ts) { droppedNoTs++; return false; }       // ‰∏•Ê†ºÔºöÊó†Êó∂Èó¥Êà≥ÈöêËóè
    if (ts < cutoff) { droppedOld++; return false; } // Ë∂ÖËøá 24h ÈöêËóè
    return true;
  });
}

if (uiPeriod === "1") {
   setStatus(
    finalItems.length ? "ok" : "warn",
    finalItems.length
      ? "Showing trends from the last 24 hours"
      : "No trends detected in the last 24 hours"
  );
} else {
  setStatus(
    items.length ? "ok" : "warn",
    items.length ? `Loaded ${items.length} items.` : "No items returned."
  );
}

renderCards(type, finalItems, q);
updatePager();

      }catch(e){
        setStatus("bad", `Failed: ${String(e?.message || e)}`);
        renderCards(type, [], q);
        updatePager();
      }
    }
    
let CURRENT_PAGE = 1;
const PAGE_SIZE = 20;
let LAST_HAS_MORE = false;
let LAST_TYPE = "hashtags";
let LAST_COUNTRY = "US";
let LAST_PERIOD = "7";
let LAST_Q = "";
let LAST_TOTAL_COUNT = null;
let LAST_TOTAL_PAGES = null;

    // ---------- init ----------

function updatePager(){
  const prev = $("btnPrev");
  const next = $("btnNext");
  const info = $("pageInfo");
  const total = $("pageTotal");
  const jump = $("pageJump");

  if (info) info.textContent = `Page ${CURRENT_PAGE}`;

  if (total) {
    total.textContent = LAST_TOTAL_PAGES ? `/ ${LAST_TOTAL_PAGES}` : "";
  }

  if (jump) {
    jump.value = "";
    jump.placeholder = String(CURRENT_PAGE);
    if (LAST_TOTAL_PAGES) jump.max = String(LAST_TOTAL_PAGES);
  }

  if (prev) {
    prev.disabled = CURRENT_PAGE <= 1;
    prev.style.opacity = prev.disabled ? 0.45 : 1;
  }

  if (next) {
    const disabled = LAST_TOTAL_PAGES
      ? (CURRENT_PAGE >= LAST_TOTAL_PAGES)
      : !LAST_HAS_MORE;

    next.disabled = disabled;
    next.style.opacity = disabled ? 0.45 : 1;
  }
}

$("btnPrev")?.addEventListener("click", () => {
  if (CURRENT_PAGE > 1) {
    CURRENT_PAGE--;
    load();
  }
});

    $("btnGo")?.addEventListener("click", () => {
  const v = Number($("pageJump")?.value);
  if (!Number.isFinite(v) || v < 1) return;

  if (LAST_TOTAL_PAGES) {
    CURRENT_PAGE = Math.min(Math.max(1, v), LAST_TOTAL_PAGES);
  } else {
    CURRENT_PAGE = Math.max(1, v);
  }
  load();
});

$("pageJump")?.addEventListener("keydown", (e) => {
  if (e.key === "Enter") $("btnGo")?.click();
});

$("btnNext")?.addEventListener("click", () => {
  if (LAST_TOTAL_PAGES && CURRENT_PAGE >= LAST_TOTAL_PAGES) return;
  CURRENT_PAGE++;
  load();
});
    $("btnLoad").addEventListener("click", load);
    function resetAndLoad(){
      CURRENT_PAGE = 1;
      load();
    }
    
    $("type").addEventListener("change", resetAndLoad);
    $("country").addEventListener("change", resetAndLoad);
    $("period").addEventListener("change", resetAndLoad);
    
    // ÊêúÁ¥¢Ê°ÜÂª∫ËÆÆ debounceÔºå‰ΩÜÂÖàÁÆÄÂçïÁÇπ
    $("q").addEventListener("input", resetAndLoad);


    // auto-load on open
    load();
  </script>
</body>
</html>
